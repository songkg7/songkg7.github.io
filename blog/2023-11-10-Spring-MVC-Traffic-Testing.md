---
title: "1ëŒ€ì˜ ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ìµœëŒ€ ëª‡ ê°œì˜ ë™ì‹œ ìš”ì²­ì„ ê°ë‹¹í•  ìˆ˜ ìˆì„ê¹Œ?"
date: 2023-11-10 12:57:26 +0900
aliases: null
tags: [test, k6, aws, stress-test, spike-test, performance-test, network, timeout, spring, mvc]
categories: null
image: /assets/img/2023-11-10-Spring-MVC-Traffic-Testing/k6-logo.webp
pin: true
---

## Overview

> Spring MVC ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ë™ì‹œ ì‚¬ìš©ìë¥¼ ëª‡ ëª…ê¹Œì§€ ìˆ˜ìš©í•  ìˆ˜ ìˆì„ê¹Œ? ğŸ¤”

ìì‹ ì´ ë§Œë“  ì„œë²„ê°€ ì–´ë–¤ ìƒíƒœì—¬ì•¼ ë§ì€ ìœ ì €ë¥¼ ìˆ˜ìš©í•˜ë©´ì„œ ì•ˆì •ì ì¸ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•  ìˆ˜ ìˆì„ì§€ì— ëŒ€í•œ ëŒ€ëµì ì¸ ìˆ˜ì¹˜ë¥¼ ê°€ëŠ í•˜ê¸° ìœ„í•´ Spring MVC ì˜ tomcat ì„¤ì •ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ì˜ ë³€í™”ë¥¼ ì‚´í´ë´…ë‹ˆë‹¤.

ì´í›„ëŠ” ì‘ì„±ì˜ í¸ì˜ë¥¼ ìœ„í•´ ë¬¸ì–´ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ ğŸ™

> ê¸°ìˆ ì ì¸ ì˜¤ë¥˜ë‚˜ ì˜¤íƒ€ ë“±ì˜ ì˜ëª»ëœ ë‚´ìš©ì´ ìˆë‹¤ë©´ ëŒ“ê¸€ë¡œ ì•Œë ¤ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤ ğŸ™‡â€â™‚ï¸
{: .prompt-info}

## Test Scenario

- ë™ì‹œì— 200ëª… ì´ìƒì˜ ì‚¬ìš©ìê°€ API ë¥¼ ìš”ì²­í•˜ëŠ” ìƒí™©ì„ ê°€ì •
- í•´ë‹¹ API ê°€ ë„ˆë¬´ ë¹¨ë¦¬ ì‘ë‹µí•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê³ , ì–´ëŠ ì •ë„ì˜ ì§€ì—°ì„ ëª¨ì˜í•˜ê¸° ìœ„í•´ 5ì´ˆì˜ ëŒ€ê¸°ì‹œê°„ì„ ê°–ë„ë¡ êµ¬í˜„
- Spring MVC ì˜ tomcat ì„¤ì •ì„ ì¡°ì ˆí•´ê°€ë©´ì„œ íŠ¸ë˜í”½ ì²˜ë¦¬ëŸ‰ì„ ê²€ì¦
- í…ŒìŠ¤íŠ¸ ë°ì´í„°ì˜ ì˜¤ì—¼ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ API ëŠ” EC2 ì— ë°°í¬í•´ë†“ì€ ìƒíƒœì—ì„œ, ë¡œì»¬ì—ì„œ ë¶€í•˜ë¥¼ ë°œìƒ

## Environment

- EC2 t4g.small (Amazon Linux 2core 2GB 64bit ARM)
- SpringBoot 3.1.5
- Spring MVC
- Spring Actuator
- K6

## Test Application

ë¨¼ì € API ë¥¼ ê°„ë‹¨í•˜ê²Œ êµ¬í˜„í•œë‹¤.

```java
@RestController
public class HelloController {

    @GetMapping("/hello")
    public String hello() throws InterruptedException {
        TimeUnit.SECONDS.sleep(5); // ì²˜ë¦¬ ì‹œê°„ì„ ì‹œë®¬ë ˆì´ì…˜
        return "Hello, World!";
    }
}
```

ì–´ëŠ ì •ë„ ì˜¤ë²„ë¡œë“œê°€ ë°œìƒí•˜ëŠ” API ë¼ê³  ê°€ì •í•˜ê¸° ìœ„í•´ 5ì´ˆì˜ ì§€ì—° ì‹œê°„ì„ ì£¼ì—ˆë‹¤. ì§€ì—° ì‹œê°„ì´ ì—†ë‹¤ë©´ ìš”ì²­ì´ ë„ˆë¬´ ë¹ ë¥´ê²Œ ì²˜ë¦¬ë˜ì–´ ë„¤íŠ¸ì›Œí¬ ë™ì‘ì„ í™•ì¸í•˜ê¸° ì–´ë ¤ìš¸ ìˆ˜ ìˆë‹¤. ì´ë²ˆ ê¸€ì—ì„œ ì¡°ì ˆí•  ì„¤ì •ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

```yaml
server:
  tomcat:
    threads:
      max: 200                # ìƒì„±í•  ìˆ˜ ìˆëŠ” threadì˜ ì´ ê°œìˆ˜
    max-connections: 8192     # ìˆ˜ë¦½ê°€ëŠ¥í•œ connectionì˜ ì´ ê°œìˆ˜
    accept-count: 100         # ì‘ì—…íì˜ ì‚¬ì´ì¦ˆ
    connection-timeout: 20000 # timeout íŒë‹¨ ê¸°ì¤€ ì‹œê°„, 20ì´ˆ
```

ì„œë²„ì—ì„œì˜ ì›í™œí•œ ì„¤ì •ê°’ ìˆ˜ì •ì„ ìœ„í•´ ëª¨ë“  ë¶€ë¶„ì„ ì‹œìŠ¤í…œ í™˜ê²½ë³€ìˆ˜ë¡œ ëŒ€ì²´í•œë‹¤.

```yaml
server:
  tomcat:
    threads:
      max: ${TOMCAT_MAX_THREADS:200}
    max-connections: ${TOMCAT_MAX_CONNECTIONS:8192}
    accept-count: ${TOMCAT_ACCEPT_COUNT:100}
    connection-timeout: ${TOMCAT_CONNECTION_TIMEOUT:20000}
```

Docker Image ë¥¼ ë¹Œë“œí•˜ê¸° ìœ„í•´ Dockerfile ì„ ì‘ì„±í•œë‹¤.

```dockerfile
# java 17 multi stage build
FROM gradle:8.4.0-jdk17 as builder
WORKDIR /app
COPY . .
RUN gradle clean build

FROM openjdk:17-ea-11-jdk-slim
WORKDIR /app
COPY --from=builder /app/build/libs/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

```bash
docker build -t sample-server .
```

í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤€ë¹„ëŠ” ê±°ì˜ ë‹¤ ëë‹¤. ì´í›„ëŠ” ì ë‹¹í•œ registry ì— ì´ë¯¸ì§€ë¥¼ push í•˜ê³ , EC2 ì—ì„œ `docker run` ì„ ì‹¤í–‰í•˜ê¸°ë§Œ í•˜ë©´ ëœë‹¤. ë¶„ëŸ‰ìƒ EC2 ë¥¼ ìƒì„±í•˜ê³  ì´ë¯¸ì§€ë¥¼ ë°°í¬í•˜ëŠ” ê³¼ì •ì€ ìƒëµí•œë‹¤.

## K6

[K6](https://k6.io/) ëŠ” Grafana Lab ì—ì„œ ë§Œë“  í˜„ëŒ€ì ì¸ ë¶€í•˜í…ŒìŠ¤íŠ¸ íˆ´ì´ë‹¤. JavaScript ë¡œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìœ¼ë©°, êµ‰ì¥íˆ ë‹¤ì–‘í•œ ìƒí™©ì„ ëª¨ì˜í•˜ì—¬ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë‹¤. [Apache JMeter](https://jmeter.apache.org/) ë˜í•œ ì´ë²ˆ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì¢‹ì€ ì˜µì…˜ ì¤‘ í•˜ë‚˜ì´ì§€ë§Œ, K6 ëŠ” í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ì‹œê°í™”í•´ì¤„ Grafana ì™€ í†µí•©í•˜ê¸° ì¢‹ê³  ì‚¬ìš©ë²•ì´ ì–´ë µì§€ ì•Šì•„ ì‰½ê²Œ ë‹¤ì–‘í•œ ìƒí™©ì„ ê²€ì¦í•´ë³¼ ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ ì´ë²ˆ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ì„œëŠ” K6 ë¥¼ ì‚¬ìš©í•˜ê¸°ë¡œ í•œë‹¤. ìµœê·¼ì€ íŠ¹íˆ JMeter ë³´ë‹¤ëŠ” K6 ë¥¼ ë¨¼ì € ê³ ë ¤í•˜ê³  ìˆë‹¤.

### K6 ì„¤ì¹˜

```bash
brew install k6
```

### ëª¨ë‹ˆí„°ë§ êµ¬ì„±

ë„ì»¤ ì»´í¬ì¦ˆë¡œ Grafana ì™€ InfluxDB ë¥¼ ê°„ë‹¨í•˜ê²Œ ì‹¤í–‰í•´ì¤€ë‹¤.

```yaml
version: "3.7"

services:
  influxdb:
    image: bitnami/influxdb:1.8.5
    container_name: influxdb
    ports:
      - "8086:8086"
      - "8085:8088"
    environment:
      - INFLUXDB_ADMIN_USER_PASSWORD=bitnami123
      - INFLUXDB_ADMIN_USER_TOKEN=admintoken123
      - INFLUXDB_HTTP_AUTH_ENABLED=false
      - INFLUXDB_DB=myk6db
  granafa:
    image: bitnami/grafana:latest
    ports:
      - "3000:3000"
```

```bash
docker compose up -d
```

InfluxDB ê°€ ì •ìƒë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì. ë§Œì•½ ì•„ë˜ ëª…ë ¹ì–´ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤ë©´, `brew install influxdb-cli` ë¥¼ í†µí•´ ì»¤ë§¨ë“œë¥¼ ë¨¼ì € ì„¤ì¹˜í•´ì¤˜ì•¼ í•œë‹¤.

```bash
influx ping
# OK
```

<http://localhost:3000> ìœ¼ë¡œ ì ‘ê·¼í•˜ì—¬ ê·¸ë¼íŒŒë‚˜ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì„ í™•ì¸í•œë‹¤.

![image](/assets/img/2023-11-10-Spring-MVC-Traffic-Testing/Pasted-image-20231108094916.webp)

> Grafana ì˜ ì´ˆê¸° ê³„ì •ì •ë³´ëŠ” ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‘ admin ì„ ì…ë ¥í•˜ë©´ ëœë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ë¼ê³  ë‚˜ì˜¤ê² ì§€ë§Œ, ì´ë²ˆì— ê·¸ë¼íŒŒë‚˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” ìš´ì˜ì´ ì•„ë‹ˆë¼ í…ŒìŠ¤íŠ¸ì´ë¯€ë¡œ skip í•´ë„ ë¬´ë°©í•  ê²ƒì´ë‹¤.
{: .prompt-info}

InfluxDB ë¥¼ datasource ë¡œ ì„¤ì •í•œ ë’¤ [K6 dashboard](https://grafana.com/grafana/dashboards/2587-k6-load-testing-results/) URL ì„ ë³µì‚¬í•˜ì—¬ import í•´ì£¼ë©´ ëª¨ë‹ˆí„°ë§ êµ¬ì„±ì´ ì™„ë£Œëœë‹¤.

![image](https://i.imgur.com/nmxIbXm.webp)
_5ë¶„ì´ë©´ ëª¨ë‹ˆí„°ë§ í™˜ê²½ êµ¬ì„± ë...!_

### Test script ì‘ì„±

ìŠ¤íŒŒì´í¬ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œ ì•„ë˜ì™€ ê°™ì€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì—ˆë‹¤.

```js
// spike-test.js
import http from 'k6/http';
import { check } from 'k6';

export const options = {
    scenarios: {
        spike: {
            executor: 'constant-vus',
            vus: 300,
            duration: '1s',
        },
    },
};

export default function () {
    const res = http.get('http://{EC2_INSTANCE_IP}/hello');
    check(res, { 'is status 200': (r) => r.status == 200 });
};
```

ê°„ë‹¨í•˜ê²Œ ì¤‘ìš”í•œ í‚¤ì›Œë“œë§Œ ì„¤ëª…í•´ë³´ë©´,

- `constant-vus`: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ ê³ ì •ëœ ìœ ì €ë¥¼ ë¯¸ë¦¬ ìƒì„±í•´ì£¼ëŠ” executor
- `vus`: virtual users ë¡œ, í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©í•  ìœ ì € ìˆ˜ë¥¼ ì˜ë¯¸í•œë‹¤

## í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ë¶„ì„

ì•„ë˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ ìˆ˜í–‰ëœë‹¤.

```bash
k6 run --out influxdb=http://localhost:8086/myk6db spike-test.js
```

### 300 requests

ë¨¼ì € ê°€ë³ê²Œ 300 ê°œì˜ ìš”ì²­ì„ ë˜ì ¸ë³´ì. ì˜ˆìƒë˜ëŠ” ë™ì‘ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

- ìŠ¤ë ˆë“œ í’€ì˜ max ìŠ¤ë ˆë“œ ìˆ˜ëŠ” 200ê°œì´ê³ , ì‘ì—… í(acceptCount)ëŠ” 100ì´ë‹¤. ë”°ë¼ì„œ 200ê°œì˜ ìš”ì²­ì€ ë°”ë¡œ ì²˜ë¦¬ë˜ê³  ì´ì–´ì„œ 100ê°œì˜ ìš”ì²­ì´ ì²˜ë¦¬ë  ê²ƒì´ë‹¤

![Imgur](https://i.imgur.com/bVfAhxd.webp)

ì˜ˆìƒëŒ€ë¡œ 5ì´ˆ ê°„ê²©ìœ¼ë¡œ 200ê°œì˜ ìš”ì²­ì´ ë¨¼ì € ì²˜ë¦¬ë˜ê³  ë’¤ì´ì–´ 100ê°œì˜ ë‚˜ë¨¸ì§€ ìš”ì²­ì´ ì²˜ë¦¬ë˜ì—ˆë‹¤.

### 1000 requests

![](https://i.imgur.com/RhJG0Wq.webp)

ì—­ì‹œë‚˜ 5ì´ˆ ê°„ê²©ìœ¼ë¡œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì´ ì²˜ë¦¬ ì‹œê°„ì€ 25s ë‚¨ì§“ì´ ê±¸ë¦°ë‹¤. ê°€ì¥ ë¹ ë¥´ê²Œ ì ‘ê·¼í•œ ì‚¬ìš©ìëŠ” 5.01s ë§Œì— ê²°ê³¼ë¥¼ í™•ì¸í•˜ê² ì§€ë§Œ, ê·¸ë ‡ì§€ ëª»í•œ ì‚¬ìš©ìëŠ” 25s ë¥¼ ê¸°ë‹¤ë ¤ì•¼ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì´ ì‹œì ì— ê¸°ë³¸ í†°ìº£ ì„¤ì •ì˜ `connection-timeout` ì¸ 20s ë¥¼ ë„˜ì—ˆë‹¤. í•˜ì§€ë§Œ íƒ€ì„ì•„ì›ƒ ì—ëŸ¬ëŠ” ë°œìƒí•˜ì§€ ì•Šì•˜ê³ , 20s ì´ìƒì„ ê¸°ë‹¤ë ¤ì„œë¼ë„ ëª¨ë‘ ì²˜ë¦¬ë˜ì—ˆë‹¤. `connection-timeout` ì´ request ë°œìƒ ìˆœê°„ë¶€í„°ëŠ” ì•„ë‹ˆë¼ëŠ” ê²ƒì„ ì¶”ì¸¡í•  ìˆ˜ ìˆëŠ” ëŒ€ëª©ì´ë‹¤. ìì„¸í•œ ë¶€ë¶„ì€ ì´í›„ ë‹¤ì‹œ ì„¤ëª…í•œë‹¤.

### 2000 requests

ì´ì¯¤ì—ì„œ í•œ ë²ˆ ê³ ë¹„ê°€ ì°¾ì•„ì˜¨ë‹¤.

K6 ì—ì„œëŠ” ì¼ì • ì‹œê°„ ì´ìƒ ì‹¤í–‰ë˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ ì¤‘ì§€í•˜ëŠ” `gracefulStop`[^fn-nth-1] ê¸°ëŠ¥ì´ ì¡´ì¬í•œë‹¤. ì´ ê¸°ëŠ¥ì€ 30s ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆì–´ì„œ **timeout ì„ ë³´ê¸° ì „ì— í…ŒìŠ¤íŠ¸ë¥¼ ì¤‘ë‹¨**ì‹œí‚¤ë¯€ë¡œ, ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢€ ìˆ˜ì •í•´ì„œ ë” ì˜¤ëœ ê¸°ê°„ í…ŒìŠ¤íŠ¸ê°€ ìˆ˜í–‰ë˜ë„ë¡ í•´ì•¼ í•œë‹¤.

```js
import http from 'k6/http';
import { check } from 'k6';

export const options = {
    scenarios: {
        spike: {
            executor: 'constant-vus',
            vus: 2000,
            duration: '1s',
            gracefulStop: '5m', // ì¶”ê°€
        },
    },
};

export default function () {
    const res = http.get('http://54.180.78.85/hello');
    check(res, { 'is status 200': (r) => r.status == 200 });
};
```

![](https://i.imgur.com/OegYzyC.webp)

`gracefulStop` ì‹œê°„ì„ ëŠ˜ë¦° ì´í›„ë¡œëŠ” íƒ€ì„ì•„ì›ƒì„ ë³´ê¸° ì „ì— ë¨¼ì € í…ŒìŠ¤íŠ¸ê°€ ì¢…ë£Œë˜ëŠ” ì¼ì´ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.

### 3000 requests

ë‹¤ì‹œ í•œ ë²ˆ ê³ ë¹„ê°€ ì˜¨ë‹¤.

![](https://i.imgur.com/rM78o5F.webp)

ì´ë²ˆì—ëŠ” ìš”ì²­ì´ 1ë¶„ ì •ë„ ëŒ€ê¸°í•˜ê²Œ ë˜ë©´ì„œ request timeout ì´ ë°œìƒí•œë‹¤.

200 ìŠ¤ë ˆë“œë¡œ 3000 ê°œì˜ ìš”ì²­ì„ ì²˜ë¦¬í•˜ë¯€ë¡œ, 5ì´ˆì˜ ëŒ€ê¸°ì‹œê°„ê¹Œì§€ ê³ ë ¤í•´ë³´ë©´ ìš´ì´ ì—†ëŠ” ìœ ì €ì˜ ìš”ì²­ì€ 3000 / 200 * 5 = 75(s) ë¥¼ ëŒ€ê¸°í•´ì•¼ í•œë‹¤. ë”°ë¼ì„œ íƒ€ì„ì•„ì›ƒ íšŒí”¼ë¥¼ ìœ„í•´ì„œëŠ” ì‘ë‹µì‹œê°„ì„ 15ì´ˆ ì´ìƒ ë‹¨ì¶•í•´ì•¼ í•˜ë©°, ìŠ¬ìŠ¬ tomcat ì˜ ê¸°ë³¸ì„¤ì •ìœ¼ë¡œëŠ” request timeout ì„ í”¼í•˜ê¸° ì–´ë ¤ì›Œë³´ì¸ë‹¤. í•´ê²°ì„ ìœ„í•´ ëª‡ ê°€ì§€ ë°©ë²•ì„ ìƒê°í•´ë³¼ ìˆ˜ ìˆë‹¤.

1. íƒ€ì„ì•„ì›ƒ ì‹œê°„ì„ ëŠ˜ë ¤ ìœ ì €ë¥¼ ë” ê¸°ë‹¤ë¦¬ê²Œ í•œë‹¤.
2. thread sleep ì„ 5ì´ˆì—ì„œ ì¡°ê¸ˆ ì¤„ì´ëŠ” ì‹ìœ¼ë¡œ ì²˜ë¦¬ ì†ë„ë¥¼ ë” ë¹ ë¥´ê²Œ í•œë‹¤.
3. thread pool ì˜ ì‚¬ì´ì¦ˆë¥¼ 200 ì—ì„œ 500 ì •ë„ë¡œ ëŠ˜ë¦¬ë©´ ë™ì‹œ ì²˜ë¦¬ëŸ‰ì´ ëŠ˜ì–´ë‚˜ë©´ì„œ í•´ê²°ë  ê²ƒì´ë‹¤.

ì´ë²ˆ í…ŒìŠ¤íŠ¸ì˜ ëª©ì ì„ ìƒê°í•´ë³´ë©´ 3ë²ˆì´ ê°€ì¥ ì ì ˆí•˜ë‹¤ê³  íŒë‹¨í•˜ê¸° ë•Œë¬¸ì—, ì´ë²ˆì—ëŠ” thread ê°œìˆ˜ë¥¼ ì¢€ ë” ëŠ˜ë ¤ë³´ëŠ” ë°©í–¥ìœ¼ë¡œ ì„ íƒí–ˆë‹¤.

ì´ì „ì— `application.yml` ì— ë¯¸ë¦¬ í™˜ê²½ë³€ìˆ˜ë¥¼ ì£¼ì… ë°›ì„ ìˆ˜ ìˆë„ë¡ í•´ë’€ë‹¤. í•œ ë²ˆ í™œìš©í•´ë³´ì.

```bash
docker run -d -p "80:8080" \
    -e TOMCAT_MAX_THREADS=500 \
    --name sample-server \
    --restart always \
    123456789012.dkr.ecr.ap-northeast-2.amazonaws.com/sample-server:v1
```

`-e TOMCAT_MAX_THREADS=500` ì˜µì…˜ì„ í†µí•´ì„œ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— í™˜ê²½ë³€ìˆ˜ë¥¼ ë„£ì–´ì¤¬ë‹¤. ì´ í™˜ê²½ë³€ìˆ˜ëŠ” `application.yml` ì— ì¡´ì¬í•˜ëŠ” ìì‹ ì˜ ìë¦¬ë¡œ ì°¾ì•„ê°€ì„œ ìŠ¤ë ˆë“œí’€ ì„¤ì •ì„ ë³€í™”ì‹œí‚¨ë‹¤.

ì´í›„ ë‹¤ì‹œ í•œ ë²ˆ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ë©´...

![](https://i.imgur.com/IaRf7y3.webp)

![](https://i.imgur.com/xLVxU9w.webp)

ì˜ˆìƒëŒ€ë¡œ íƒ€ì„ì•„ì›ƒ ì—†ì´ ì²˜ë¦¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ìŠ¤ë ˆë“œë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ìƒì„±í•´ì•¼í•˜ê¸°ì— ì„œë²„ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ì´ì „ë³´ë‹¤ëŠ” ì“°ê²Œ ë˜ê² ì§€ë§Œ, ì²˜ë¦¬ì†ë„ê°€ ì›”ë“±íˆ ë¹¨ë¼ì ¸ì„œ 75s ì—ì„œ 30s ë¡œ ì¤„ì–´ë“¤ê²Œ ë˜ì—ˆë‹¤. ì´ëŸ° ì‹ìœ¼ë¡œ ìŠ¤ë ˆë“œë§Œ ëŠ˜ë ¤ì¤˜ë„ ì„±ëŠ¥ ê°œì„ ì´ ê°€ëŠ¥í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

### 6000 requests

![](https://i.imgur.com/3dorRSj.webp)

ìŠ¤ë ˆë“œ í’€ì„ 500 ìœ¼ë¡œ ëŠ˜ë ¸ì§€ë§Œ, 6000 requests ë¶€í„°ëŠ” ë‹¤ì‹œ request timeout ì´ ë°œìƒí•œë‹¤. ë™ì‹œì²˜ë¦¬ëŸ‰ì„ ë” ëŠ˜ë ¤ì•¼í•  í•„ìš”ê°€ ìˆë‹¤. ì¢€ ì „ì— í–ˆë˜ ë°©ë²•ì²˜ëŸ¼ ìŠ¤ë ˆë“œ ê°œìˆ˜ë¥¼ ë” ëŠ˜ë¦¬ë©´ ì–´ë–¨ê¹Œ? ìŠ¤ë ˆë“œê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ë¦¬ì†ŒìŠ¤ ê²½í•©ì´ ë°œìƒí•˜ë¯€ë¡œ ê·¸ë‹¤ì§€ ë°”ëŒì§í•˜ì§€ ëª»í•˜ì§€ë§Œ, ìš°ì„  ê°€ëŠ¥í•  ë•Œê¹Œì§€ ìŠ¤ë ˆë“œë¥¼ ëŠ˜ë¦¬ëŠ” ë°©í–¥ìœ¼ë¡œ ìƒê°í•´ë³´ì. ì´ì „ê³¼ ê°™ì€ ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ 1000 ê°œë¡œ ëŠ˜ë ¤ì¤¬ë‹¤.

![](https://i.imgur.com/l7uzhej.webp)
_thread pool 1000 ì—ì„œ ë‹¤ì‹œ ì„±ê³µ_

ë‹¤í–‰íˆ ìŠ¤ë ˆë“œ 1000ê°œ ì •ë„ëŠ” 2core 2GB ì˜ EC2 ì„±ëŠ¥ìœ¼ë¡œë„ ì¶©ë¶„í•œ ê²ƒ ê°™ë‹¤. resource ì‚¬ìš©ëŸ‰ë„ í¬ê²Œ ë†’ì•„ì§€ì§€ ì•Šì•˜ìœ¼ë©° ì•ˆì •ì ì´ì˜€ë‹¤.

### 10k requests

ë“œë””ì–´ ìµœì†Œí•œì˜ ì„¤ì • ìˆ˜ì •ìœ¼ë¡œ 10k ì˜ ë™ì‹œ ìš”ì²­ì— ë„ë‹¬í–ˆë‹¤. í•˜ì§€ë§Œ ì§€ê¸ˆê¹Œì§€ ë³¼ ìˆ˜ ì—†ë˜ ì—ëŸ¬ê°€ ìŸì•„ì§€ê¸°ë„ í–ˆë‹¤.

![](https://i.imgur.com/IFYLBPd.webp)

- cannot allocate memory
- connection reset by peer
- request timeout (20s ì—ì„œ ë°œìƒ)
- i/o timeout

ë¨¼ì €, ì •í™•í•œ ì—ëŸ¬ ì›ì¸ íŒŒì•…ì„ ìœ„í•´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œì ì— TCP ì—°ê²°ì´ ëª‡ ê°œë‚˜ ìˆ˜ë½ë˜ëŠ”ì§€ ëª¨ë‹ˆí„°ë§í•´ë´¤ë‹¤. ë¦¬ëˆ…ìŠ¤ì—ì„œ ì†Œì¼“ ëª¨ë‹ˆí„°ë§ì„ ìœ„í•´ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” `ss` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í–ˆë‹¤.

```bash
# TCP ìˆ˜ ëª¨ë‹ˆí„°ë§
watch ss -s
```

![](https://i.imgur.com/LCIm2BW.webp)
_closed ê°€ 10k ì— ë¯¸ì¹˜ì§€ ëª»í•œë‹¤. ì •ìƒì ìœ¼ë¡œ ì»¤ë„¥ì…˜ì´ ìƒì„±ë˜ì—ˆë‹¤ë©´ 10k ë¥¼ ë„˜ì—ˆì„ ê²ƒì´ë‹¤._

10k ì˜ TCP ì»¤ë„¥ì…˜ì„ ë§ºì„ ìˆ˜ ì—†ëŠ” ê²ƒì„ í™•ì¸í–ˆë‹¤. ì§€ê¸ˆê¹Œì§€ëŠ” ìœ ì €ì˜ ìˆ˜ëŒ€ë¡œ ì •í™•í•˜ê²Œ TCP ì»¤ë„¥ì…˜ì´ ì¦ê°€í•˜ëŠ” ê²ƒì„ í™•ì¸í–ˆëŠ”ë° ì²˜ìŒìœ¼ë¡œ ì»¤ë„¥ì…˜ ê°œìˆ˜ê°€ ìš”ì²­ ìˆ˜ë³´ë‹¤ ëª¨ìë¼ê¸° ì‹œì‘í•œë‹¤.

![](https://i.imgur.com/IbJrKrz.webp)

ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë˜ì§€ ì•Šì€ ì»¤ë„¥ì…˜ì´ ì •ë¦¬ë ë•Œê¹Œì§€ ì•½ê°„ì˜ í…€ì„ ë‘ê³  ëª‡ ë²ˆì„ ë°˜ë³µí•´ë„ 8293 vus ë§Œ ì„±ê³µí–ˆë‹¤. ì™œ ê·¸ëŸ´ê¹Œ?

ì´ ì‹œì ì—ì„œ ëª‡ ê°€ì§€ ìƒê°í•´ë³¼ ìˆ˜ ìˆëŠ” ë¶€ë¶„ì„ ì •ë¦¬í•´ë³´ë©° ê°€ì„¤ì„ ë§Œë“¤ì–´ë³´ì.

1. `max-connections` ì†ì„±ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ TCP ìµœëŒ€ ì»¤ë„¥ì…˜ ê°œìˆ˜ì™€ ì—°ê´€ì´ ìˆì„ ê²ƒì´ë‹¤.
2. request timeout ì€ TCP ì—°ê²°ì„ ë§ºì§€ ëª»í•œ ìƒíƒœë¡œ 20s ê°€ ê²½ê³¼í•˜ì—¬ ë°œìƒí•œ connection-timeout ì—ëŸ¬ì¼ ê²ƒì´ë‹¤.
3. `accept-count` ì†ì„±ë„ ë§ˆì°¬ê°€ì§€ë¡œ TCP ìµœëŒ€ ì»¤ë„¥ì…˜ ê°œìˆ˜ì™€ ì—°ê´€ì´ ìˆì„ ê²ƒì´ë‹¤. (8192 + 100 ì´ 8293 ì˜ ê·¼ì‚¬ì¹˜ì´ê¸° ë•Œë¬¸ì—)
4. `max-connections` ì„ ì¦ê°€ì‹œí‚¤ë©´ ì»¤ë„¥ì…˜ì„ ë” ë§ì´ ë§ºì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, connection timeout ì„ íšŒí”¼í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.

ì´ í›„ ë‹¨ê³„ëŠ” ìœ„ ê°€ì„¤ì„ í•˜ë‚˜ì”© ê²€ì¦í•´ë³¸ë‹¤. ë„ì»¤ëŠ” OS ë¥¼ ê³µìœ í•˜ê¸° ë•Œë¬¸ì—, ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ë…ë¦½ì ì´ë„ë¡ ì„¤ì •ì„ ë°”ê¿”ì•¼í•  ë•Œë§ˆë‹¤ ê¸°ì¡´ì— ë™ì‘ ì¤‘ì´ì˜€ë˜ ì»¨í…Œì´ë„ˆëŠ” ì •ì§€ í›„ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•˜ë©° ì§„í–‰í–ˆë‹¤.

#### 1. Max Connections

> `max-connections` ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ TCP ìµœëŒ€ ì»¤ë„¥ì…˜ ê°œìˆ˜ì™€ ì—°ê´€ì´ ìˆì„ ê²ƒì´ë‹¤?

ë¨¼ì € max connection ê°’ì„ 20k ë¡œ ì¦ê°€ì‹œí‚¤ê³  í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•œë‹¤.

![](https://i.imgur.com/7wQDXG6.webp)

ì˜¤í˜¸... ì´ì „ê³¼ëŠ” ë‹¤ë¥´ê²Œ ì»¤ë„¥ì…˜ì´ 10k ë¥¼ ë„˜ê²¨ì„œ ìƒì„±ë˜ì—ˆë‹¤.

![](https://i.imgur.com/ETTdN93.webp)

ì‹¬ì§€ì–´ ì•„ë¬´ëŸ° ì—ëŸ¬ ì—†ì´ ì„±ê³µí•œë‹¤. ì´ë¡œì¨ `max-connections` ì€ OS ì— ìƒì„±ë˜ëŠ” **ì»¤ë„¥ì…˜ì˜ ìˆ˜ì™€ ì§ì ‘ì ìœ¼ë¡œ ê´€ë ¨ë˜ì–´ ìˆë‹¤**ê³  ìƒê°í•  ìˆ˜ ìˆë‹¤.

#### 2. Connection Timeout

> request timeout ì€ TCP ì—°ê²°ì„ ë§ºì§€ ëª»í•œ ìƒíƒœë¡œ 20s ê°€ ê²½ê³¼í•˜ì—¬ ë°œìƒí•œ `connection-timeout` ì„¤ì • ê´€ë ¨ ì—ëŸ¬ì¼ ê²ƒì´ë‹¤?

ì´ë²ˆì—ëŠ” `max-connections` ë¥¼ ë‹¤ì‹œ ê¸°ë³¸ê°’ìœ¼ë¡œ í•˜ê³ , `connection-timeout` ì„ 30s ë¡œ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ë³´ì.

```yaml
max-connections: 8192
connection-timeout: 30000
```

ì—¬ì „íˆ 20s ë¥¼ ì§€ë‚  ì¦ˆìŒ request timeout ì´ ë°œìƒí–ˆë‹¤. ê·¸ë ‡ë‹¤ë©´, `connection-timeout` ì€ ì—°ê²°ì˜ ì‹œì‘ ì‹œì ê³¼ëŠ” ë¬´ê´€í•˜ë‹¤ê³  ìƒê°í•  ìˆ˜ ìˆë‹¤.

ì‚¬ì‹¤ ì´ ì„¤ì •ì€ í´ë¼ì´ì–¸íŠ¸ì™€ **ì—°ê²°ì„ ë§ºì€ ì´í›„ ì¢…ë£Œí•  ë•Œê¹Œì§€ì˜ íƒ€ì„ì•„ì›ƒ**[^fn-nth-2]ì´ë‹¤. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œì  20s ì— ë°œìƒí•˜ëŠ” timeout ì—ëŸ¬ëŠ” `maxConnections`, `acceptCount` ê°€ ëª¨ë‘ ê°€ë“ì°¨ì„œ ë” ì´ìƒ ì»¤ë„¥ì…˜ì´ ìˆ˜ë½ë˜ì§€ ì•Šì•„ ë°œìƒí•˜ëŠ” timeout ì—ëŸ¬ì´ë‹¤.

ì¦‰, `connection-timeout` ì˜µì…˜ê³¼ëŠ” **ê´€ë ¨ì´ ì—†ìœ¼ë©°** ê´€ë ¨ ë‚´ìš©ì€ ë°”ë¡œ ë‹¤ìŒì—ì„œ ìì„¸íˆ ì„¤ëª…í•œë‹¤.

#### 3. Accept Count

> `accept-count` ì†ì„±ë„ ë§ˆì°¬ê°€ì§€ë¡œ TCP ìµœëŒ€ ì»¤ë„¥ì…˜ ê°œìˆ˜ì™€ ì—°ê´€ì´ ìˆì„ ê²ƒì´ë‹¤?

ì´ë²ˆì—ëŠ” `accept-count` ë§Œ ëŠ˜ë ¤ë³´ì.

```yaml
max-connections: 8192
accept-count: 2000 # ì‘ì—… í
```

`accept-count` ê°€ 100 ì¼ ë•Œ ì„±ê³µí•œ ìš”ì²­ ìˆ˜ëŠ” 8293 ì´ì˜€ë‹¤. 2000 ìœ¼ë¡œ ëŠ˜ë¦¬ë©´ 10k ì´ìƒì˜ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆì„ê¹Œ? í˜¹ì€ TCP ì—°ê²° ìˆ˜ë½ ê°œìˆ˜ì™€ ì‘ì—… íê°€ ì§ì ‘ì ì¸ ê´€ë ¨ì€ ì—†ì„í…Œë‹ˆ ì—¬ì „íˆ ì‹¤íŒ¨í• ê¹Œ? ë°±ë¬¸ì´ë¶ˆì—¬ì¼ê²¬, ì§ì ‘ í™•ì¸í•´ë³´ì.

![](https://i.imgur.com/9MohYiI.webp)

![](https://i.imgur.com/B6aR4Y8.webp)

ê²°ê³¼ëŠ” ì•„ì£¼ ì¸ìƒì ì´ë‹¤. `max-connections` ì„ ì „í˜€ ëŠ˜ë¦¬ì§€ ì•Šì•˜ê³  `accept-count` ë§Œ ëŠ˜ë ¤ì£¼ì—ˆëŠ”ë° 10k ì´ìƒì˜ TCP ì—°ê²°ì´ ìˆ˜ë½ë˜ì—ˆë‹¤.

ëª‡ëª‡ ë¸”ë¡œê·¸ì—ì„œëŠ” `accept-count` ì—ì„œ ëŒ€ê¸°í•˜ëŠ” ì‘ì—…(request)ì€ TCP connection ì„ ë§ºì§€ ì•ŠëŠ”ë‹¤ê³  ì„¤ëª…í•˜ê³  ìˆì—ˆë‹¤. 'ë‚´ê°€ í˜¹ì‹œ ì„¤ì •ì„ ì˜ëª»í–ˆë‚˜?' ì‹¶ì–´ì„œ actuator ë¥¼ í™œìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì„¤ì •ì„ í™•ì¸í•´ë´¤ì§€ë§Œ, ì˜ë„í•œëŒ€ë¡œ ì„¤ì •ëœ ìƒíƒœë‹¤.

![](https://i.imgur.com/81Rk4Qj.webp)
_actuator ëŠ” ë™ì‘ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ”ë° ë§¤ìš° ìœ ìš©í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤_

`ServerProperties` í´ë˜ìŠ¤ì˜ javaDoc ì„ ì‚´í´ë³´ë©´ ì´ ì˜ë¬¸ì— ëŒ€í•œ íŒíŠ¸ë¥¼ ë°œê²¬í•  ìˆ˜ ìˆë‹¤.

```java
/**
 * Maximum number of connections that the server accepts and processes at any
 * given time. Once the limit has been reached, the operating system may still
 * accept connections based on the "acceptCount" property.
 */
private int maxConnections = 8192;

/**
 * Maximum queue length for incoming connection requests when all possible request
 * processing threads are in use.
 */
private int acceptCount = 100;
```

`maxConnections` í•„ë“œì— ì‘ì„±ëœ ì£¼ì„ì„ ì‚´í´ë³´ì.

> Once the limit has been reached, the operating system may still accept connections based on the "acceptCount" property (ì œí•œì— ë„ë‹¬í•œ ë’¤ì—ë„, ìš´ì˜ì²´ì œëŠ” "acceptCount" ì†ì„±ì— ë”°ë¼ ì—¬ì „íˆ ì»¤ë„¥ì…˜ì„ ìˆ˜ë½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)

`maxConnections` ì œí•œì— ë„ë‹¬í•˜ë©´, `acceptCount` ì˜ ê°’ë§Œí¼ OS ê°€ ì¶”ê°€ ì»¤ë„¥ì…˜ì„ ìˆ˜ë½í•˜ê²Œ í•œë‹¤ëŠ” ë‚´ìš©ì´ë‹¤. 8192(maxConnections) + 100(accept) = 8293[^fn-nth-3] ì¼ ê²ƒì´ë¼ëŠ” ê¸°ì¡´ì˜ ê°€ì„¤ì„ ë’·ë°›ì¹¨í•´ì£¼ëŠ” ë¶€ë¶„ì´ë‹¤.

ì •ë¦¬í•˜ìë©´,

1. `max-connections` ì„ ì´ˆê³¼í•œ ìš”ì²­ì€ `acceptCount` ë§Œí¼ **TCP connection ì´ ìˆ˜ë½ëœ ìƒíƒœì—ì„œ ì‘ì—… í(ì´ëŸ° ì´ìœ ë¡œ acceptorQueue ë¼ê³ ë„ í•œë‹¤)ì—ì„œ ëŒ€ê¸°**í•œë‹¤.
2. NIO Connector ëŠ” ì‘ì—… íì—ì„œ ìš”ì²­ì„ ê°€ì ¸ì™€ì„œ ë‚¨ì•„ìˆëŠ” worker thread ì—ê²Œ í• ë‹¹í•œë‹¤.
3. `acceptCount` ë§Œí¼ì˜ **ì‘ì—… íë§ˆì € ê½‰ ì°¬ë‹¤ë©´ TCP connection ì„ ë§ºì§€ ëª»í•˜ê³  ëŒ€ê¸°í•˜ë‹¤ê°€ request timeout ì´ ë°œìƒ**í•œë‹¤.

`acceptCount` ëŠ” ìµœëŒ€ ì»¤ë„¥ì…˜ ê°œìˆ˜ì™€ ë„ˆë¬´ë‚˜ ë°€ì ‘í•œ ê´€ê³„ì— ìˆë‹¤ê³  í•  ìˆ˜ ìˆê² ë‹¤.

![](https://i.imgur.com/LVUTzYy.webp)

> ê·¸ë ‡ë‹¤ë©´ `threads.max`, `max-connections`, `accept-count` ë¥¼ ëª¨ë‘ 1ë¡œ í• ë‹¹í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ? ì²˜ë¦¬ëŸ‰ì— ë”°ë¼ì„œ ì‹œê°„ ì•ˆì— connection ì´ ìˆ˜ë½ë˜ì§€ ì•Šì€ ìš”ì²­ì€ timeout ì´ ë°œìƒí•  ê²ƒì´ë‹¤. í˜„ì¬ í™˜ê²½ì—ì„œëŠ” 3ê°œê°€ ì„±ê³µí•˜ê³  7ê°œê°€ ì‹¤íŒ¨í–ˆë‹¤. ì—¬ê¸°ì„œ `acceptCount` ë¥¼ 10ìœ¼ë¡œ ëŠ˜ë¦¬ë©´, ëª¨ë“  ìš”ì²­ì— ì»¤ë„¥ì…˜ì´ ìˆ˜ë½ë˜ë¯€ë¡œ ëª¨ë‘ ì„±ê³µí•œë‹¤.
{: .prompt-tip}

#### 4. Max Connections ì™€ Connection Timeout

> `max-connections` ì„ ì¦ê°€ì‹œí‚¤ë©´ ì»¤ë„¥ì…˜ì„ ë§ºì€ ìƒíƒœì´ê¸° ë•Œë¬¸ì— connection timeout ì„ íšŒí”¼í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤?

2ë²ˆì—ì„œ ì‚´í´ë´¤ë˜ ë‚´ìš©ê³¼ ë‹¤ì†Œ ì¼ë§¥ìƒí†µí•˜ëŠ” ë¶€ë¶„ì´ ìˆëŠ” ë‚´ìš©ì´ë‹¤. `connection-timeout` ì€ ì»¤ë„¥ì…˜ì„ ìˆ˜ë½í•œ ì´í›„ ì¢…ë£Œë˜ê¸° ì „ê¹Œì§€ì˜ ìœ ì˜ˆ ì‹œê°„ê³¼ ê´€ë ¨ëœ íƒ€ì„ì•„ì›ƒ ì„¤ì •ì´ë‹¤. `max-connections` ì„ ì¦ê°€ì‹œì¼œì„œ íšŒí”¼í•  ìˆ˜ ìˆëŠ” íƒ€ì„ì•„ì›ƒì€ ì»¤ë„¥ì…˜ ìì²´ê°€ ìˆ˜ë½ë˜ì§€ ëª»í•´ ë°œìƒí•˜ëŠ” íƒ€ì„ì•„ì›ƒì´ë‹¤. `max-connections` ìœ¼ë¡œ íƒ€ì„ì•„ì›ƒì„ íšŒí”¼í•  ìˆ˜ ìˆê¸´ í•˜ì§€ë§Œ ê·¸ ì¢…ë¥˜ê°€ ë‹¤ë¥´ë‹¤.

#### 10k problem ê²°ë¡ 

maxConnections ê³¼ acceptCount ëª¨ë‘ ìµœëŒ€ ì»¤ë„¥ì…˜ì— ì˜í–¥ì„ ì£¼ë¯€ë¡œ ë‘˜ì˜ í•©ì´ 10k ë¥¼ ë„˜ê²Œ í•œë‹¤ë©´ ë™ì‹œ ë°œìƒí•˜ëŠ” 10k ì»¤ë„¥ì…˜ë„ ê½¤ ì—¬ìœ ë¡­ê²Œ ìˆ˜ë½í•  ìˆ˜ ìˆë‹¤. ì ì ˆí•œ ë¹„ìœ¨ì€ ì»¤ë„¥ì…˜ ìƒì„± ë¹„ìš© ë° ìŠ¤ë ˆë“œ ìƒì„± ê°œìˆ˜ë¥¼ ë”°ì ¸ë´ì•¼í•  ê²ƒì´ë‹¤.

![](https://i.imgur.com/kqFYz7r.webp)

![](https://i.imgur.com/4t3cnnO.webp)
_10k ì„±ê³µ_

## ì–¼ë§ˆë‚˜ ì²˜ë¦¬ ê°€ëŠ¥í• ê¹Œ?

OS level ì˜ ì„¤ì •ì„ ì¡°ì ˆí•˜ì§€ ì•Šê³ (ulimit ë“±) ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •ë§Œ ì¡°ì ˆí•˜ëŠ” ê²ƒìœ¼ë¡œë„ 15000 vus ê¹Œì§€ëŠ” ì—ëŸ¬ì—†ì´ ì²˜ë¦¬í•  ìˆ˜ ìˆì—ˆë‹¤.

![](https://i.imgur.com/EQh4bqh.webp)

ì„¤ì •ì€ ì•„ë˜ì²˜ëŸ¼ ì‚¬ìš©í–ˆë‹¤.

```yaml
thread:
  max: 2000
max-connections: 50000
accept-count: 5000
```

ë‹¤ì†Œ ê³¼ê²©í•œ(?) `max-connections` ê³¼ `accept-count` ê°’ì¸ë°, `max-connections` ê°’ì´ í¬ë‹¤í•´ì„œ ì‹¤ì œë¡œ ê·¸ë§Œí¼ ì»¤ë„¥ì…˜ì´ ìˆ˜ë½ëœë‹¤ëŠ” ë³´ì¥ì´ ìˆì§„ ì•Šë‹¤. ì´ ì„¤ì •ìœ¼ë¡œë„ 20k ì´ìƒì˜ ìš”ì²­ì—ì„œëŠ” `cannot assign requested address` ë¥¼ ë¹„ë¡¯í•œ ë‹¤ì–‘í•œ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©° ì»¤ë„¥ì…˜ì´ ìˆ˜ë½ë˜ì§€ ì•Šì•˜ë‹¤. ì†Œì¼“ì´ë‚˜ í¬íŠ¸ í• ë‹¹ê³¼ ê´€ë ¨ëœ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œê°€ ì•„ë‹ê¹Œ ì‹¶ì€ë° ì •í™•í•˜ê²Œ ì•Œì•„ë‚´ì§€ëŠ” ëª»í•´ì„œ ì´ ë¶€ë¶„ì€ ë‹¤ìŒ ê¸°íšŒì— ë„¤íŠ¸ì›Œí¬ë¥¼ ì¶”ê°€ì ìœ¼ë¡œ í•™ìŠµí•´ë‚˜ê°€ë©´ì„œ í™•ì¸í•´ë´ì•¼í•  ê²ƒ ê°™ë‹¤.

ë˜ í•œê°€ì§€ ì£¼ì˜í•´ì•¼í•  ì ì€, ì»¤ë„¥ì…˜ì„ ë§ì´ ìˆ˜ë½í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ ìš”ì²­ì„ ë‹¤ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤ëŠ” ì˜ë¯¸ëŠ” ì•„ë‹ˆë¼ëŠ” ì ì´ë‹¤. ì»¤ë„¥ì…˜ì´ ìˆ˜ë½ë˜ì–´ë„ ì²˜ë¦¬ì†ë„ê°€ ì¶©ë¶„íˆ ë¹ ë¥´ì§€ ì•Šë‹¤ë©´ ê²°êµ­ í´ë¼ì´ì–¸íŠ¸ëŠ” 60s ì•ˆì— ì‘ë‹µì„ ë°›ì§€ ëª»í•´ ë§¤ìš° ë§ì€ ìš”ì²­ì´ request timeout ìœ¼ë¡œ ì¢…ë£Œë  ê²ƒì´ë‹¤.

> `max-connections` ëŠ” ê·¸ë¦‡ì— ìµœëŒ€ë¡œ ì±„ìš¸ ìˆ˜ ìˆëŠ” ë¬¼ì˜ ì–‘ì´ë©°, ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì²˜ë¦¬ ì†ë„(throughput)ëŠ” ë¬¼ì„ í¼ë‚´ëŠ” ì†ë„ì™€ ê°™ë‹¤. ì •í•´ì§„ ì‹œê°„ ì•ˆì— ë¬¼ì„ ë‹¤ í¼ë‚´ì§€ ëª»í•˜ë©´ OS ë¼ëŠ” ê´€ë¦¬ìëŠ” ê·¸ë¦‡ì— ë‚¨ì€ ë¬¼ì„ ë°”ë‹¥ì— ë‹¤ ìŸì•„ë²„ë¦°ë‹¤.

## ë§ˆë¬´ë¦¬

- `max-connections`, `accept-count` ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‚¬ìš©í•˜ëŠ” ì»¤ë„¥ì…˜ ìˆ˜ì— ì˜í–¥ì„ ì¤€ë‹¤.
- `threads.max` ëŠ” ì²˜ë¦¬ëŸ‰(throughput)ì— ì§ì ‘ì ì¸ ì˜í–¥ì„ ì£¼ëŠ” ì¤‘ìš”í•œ ì†ì„±ì´ë‹¤.
- `connection-timeout` ì€ ì»¤ë„¥ì…˜ì„ ë§ºì§€ ëª»í•  ë•Œ ë°œìƒí•˜ëŠ” request timeout ê³¼ëŠ” ê´€ë ¨ì´ ì—†ë‹¤.
- `max-connections` ì´ ì¶©ë¶„íˆ í° ê°’ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆë”ë¼ë„, OS ê°€ ìˆ˜ìš©í•  ìˆ˜ ìˆëŠ” ì»¤ë„¥ì…˜ì—ëŠ” í•œê³„ê°€ ìˆë‹¤.
- `accept-count` ëŠ” `max-connections` ì„ ì´ˆê³¼í–ˆì„ ë•Œ OS ê°€ connection ì„ `accept-count` ë§Œí¼ ì¶”ê°€ì ìœ¼ë¡œ ìˆ˜ë½í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ì†ì„±ì´ë‹¤.

ìµœê·¼ '1ëŒ€ì˜ ì„œë²„ë¥¼ ì‚¬ìš©í•  ë•Œ Spring MVC ê°€ ë™ì‹œ ì ‘ì†ìë¥¼ ëª‡ ëª…ì´ë‚˜ ì²˜ë¦¬í•  ìˆ˜ ìˆë‚˜ìš”?' ë¼ëŠ” ì§ˆë¬¸ì— ì• ë§¤ëª¨í˜¸í•˜ê²Œ ëŒ€ë‹µí•  ìˆ˜ ë°–ì— ì—†ë˜ê²Œ ì•„ì‰¬ì›Œì„œ ì—¬ê¸°ê¹Œì§€ ì˜¤ê²Œ ë˜ì—ˆë‹¤. ì¡°ê±´ì— ë”°ë¼ì„œ ë³€ë™í­ì´ ë§¤ìš° í´ ìˆ˜ ìˆì–´ì„œ ìˆ˜ì¹˜ë¡œ ì •ëŸ‰í™”í•˜ê¸° ì¡°ì‹¬ìŠ¤ëŸ½ê³  ì–´ë ¤ìš´ ë‚´ìš©ì´ì§€ë§Œ ê·¸ë˜ë„ ì •ë¦¬í•´ë³¸ë‹¤.

**"ì„œë²„ì˜ ì„±ëŠ¥, ì´ˆë‹¹ ì²˜ë¦¬ëŸ‰(throughput) ê³¼ ê°™ì€ ì¡°ê±´ì— ë”°ë¼ ë§¤ìš° í¬ê²Œ ì°¨ì´ê°€ ë‚˜ì§€ë§Œ, AMI 2core 2GB ì—ì„œ 5ì´ˆ ì •ë„ì˜ ì§€ì—°ì‹œê°„ì´ ìˆëŠ” API ëŠ” ìµœì†Œ 15000 ëª…ì˜ ì‚¬ìš©ìê°€ ë™ì‹œì— ìš”ì²­í•´ë„ ì—ëŸ¬ë¥¼ ë³´ì—¬ì£¼ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."**

~~ë­”ê°€ë¥¼ ì•Œê²Œ ë ìˆ˜ë¡ ëª¨ë¥´ëŠ” ê²ƒë“¤ë§Œ ë” ëŠ˜ì–´ë‚˜ëŠ” ê²ƒ ê°™ë‹¤...~~

> ê¸€ì— ì‚¬ìš©ëœ ì½”ë“œëŠ” GitHub [test-script](https://github.com/songkg7/spike-test), [sample-server](https://github.com/songkg7/sample-server)ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{: .prompt-info}

## ë¯¸ì²˜ ë‹¤ë£¨ì§€ ëª»í•œ ë‚´ìš©ë“¤

ì•„ë˜ ë‚´ìš©ë“¤ì€ ì´ ê¸€ì„ ì‘ì„±í•˜ë©´ì„œ ì •ë¦¬í–ˆë˜ ë‚´ìš©ë“¤ì´ì§€ë§Œ ì£¼ì œì—ì„œ ë‹¤ì†Œ ë²—ì–´ë‚˜ ìˆê±°ë‚˜, ë³„ë„ë¡œ ë¶„ë¦¬í• ë§Œí•œ ì£¼ì œë¼ê³  ìƒê°í•œ ëª©ë¡ë“¤ì…ë‹ˆë‹¤.

- EC2 ì— SSM ìœ¼ë¡œ ì ‘ì†í•˜ê¸°, ECR ì‚¬ìš©ë²•, AWS Identity Center ë¡œ SSO ë¥¼ ì„¤ì •í•´ë³´ì
- allocate memory error ëŠ” ì„œë²„ ì¸¡ ë©”ëª¨ë¦¬ë¥¼ ëŠ˜ë¦¬ê±°ë‚˜, swap ë©”ëª¨ë¦¬ë¥¼ ì„¤ì •í•˜ëŠ” ê²ƒì´ í•´ê²°ë°©ë²•ì´ ë  ìˆ˜ ìˆë‹¤
- i/o timeout ì˜ ë°œìƒ ì›ì¸ì„ ì‚´í´ë³´ê¸°
- BIO Connector ì™€ NIO Connector ì˜ ì°¨ì´ì ê³¼ ë™ì‘ íë¦„ì„ ì‚´í´ë³´ê¸°
- ì»¤ë„¥ì…˜, ì†Œì¼“, í¬íŠ¸. 3ê°€ì§€ ê°œë…ì˜ ìœ ì‚¬ì„±ê³¼ ë™ì‹œ ìœ ì € ì ‘ê·¼ê³¼ì˜ ìƒê´€ê´€ê³„ ì‚´í´ë³´ê¸°

## Reference

- [Grafana K6 ë¡œ ë¶€í•˜í…ŒìŠ¤íŠ¸ ì‹œê°í™”í•˜ê¸°](https://velog.io/@heka1024/Grafana-k6%EC%9C%BC%EB%A1%9C-%EB%B6%80%ED%95%98-%ED%85%8C%EC%8A%A4%ED%8A%B8%ED%95%98%EA%B8%B0)
- [K6 spike test](https://k6.io/docs/test-types/spike-testing/)
- [100k_concurrent_server](https://shdkej.com/blog/100k_concurrent_server/)
- [spring-boot-configure-tomcat](https://www.baeldung.com/spring-boot-configure-tomcat)
- [https://junuuu.tistory.com/835](https://junuuu.tistory.com/835)
- [NIO Connector ì™€ BIO Connector ì— ëŒ€í•´ ì•Œì•„ë³´ì](https://velog.io/@cjh8746/%EC%95%84%ED%8C%8C%EC%B9%98-%ED%86%B0%EC%BA%A3%EC%9D%98-NIO-Connector-%EC%99%80-BIO-Connector%EC%97%90-%EB%8C%80%ED%95%B4-%EC%95%8C%EC%95%84%EB%B3%B4%EC%9E%90)
- [about-springboot-tomcat-acceptcount-pool](https://stackoverflow.com/questions/65779046/about-springboot-tomcat-acceptcount-pool)
- [tomcat-8.5-doc](https://tomcat.apache.org/tomcat-8.5-doc/config/http.html)

---

[^fn-nth-1]: [K6 graceful stop](https://k6.io/docs/using-k6/scenarios/concepts/graceful-stop/)
[^fn-nth-2]: [spring-boot-configure-tomcat](https://www.baeldung.com/spring-boot-configure-tomcat#3-server-connections)
[^fn-nth-3]: 1ì˜ ì˜¤ì°¨ëŠ” ì—¬ì „íˆ ë¯¸ìŠ¤í„°ë¦¬ì´ë‹¤.
